-- DROP TABLE    pfd_fact_overall_202406 PURGE;
CREATE TABLE  pfd_fact_overall_202406  COMPRESS FOR QUERY HIGH AS
with

tdim	as	(
select
  year_month
  ,financial_year
  ,calendar_year
  ,financial_quarter_ext
  ,financial_year||' Q'||financial_quarter				      as	financial_quarter
  
from
  dim.year_month_dim
where 1  =  1
  and year_month  between 201504  and 202303
) 

,drug	as	(
	select
		cdr.year_month
  		,record_id
  		,bnf_chapter
  		,chapter_descr
  		,bnf_section
  		,section_descr
  		,bnf_paragraph
  		,paragraph_descr
  		,bnf_sub_paragraph
 		,sub_paragraph_descr
  		,bnf_chemical_substance
  		,chemical_substance_bnf_descr
  		
        ,case when bnf_paragraph	in	('060101','060102','060104','060106','2148')		then  'Diabetes' else 'Non-Diabetes' end as drug_type
	from
		 dim.cdr_ep_drug_bnf_dim cdr
	inner join	
		tdim
		on	cdr.year_month	=	tdim.year_month
	where	1	=	1		
)

,fact	as	(
	select
		tdim.financial_year
		,'England'							as	country
		,drug.drug_type
		,fact.identified_patient_id
		--  <methodology change 2023> no longer impute patient flag from PDS data
   		,fact.patient_identified
   		,sum(fact.item_count)			as	items
		,sum(fact.item_pay_dr_nic)/100	as	nic
		,1								as	patient_count
        ,case 	when	l5.cur_area_ltst_clsd = 'Y' 	or 	l5.cur_area_team_ltst_nm	in	('ENGLISH/WELSH DUMMY DENTAL','UNIDENTIFIED DEPUTISING SERVICES','UNIDENTIFIED DOCTORS')	then	'UNKNOWN ICB'
				else 	l5.cur_frmttd_area_team_ltst_nm	end		as	icb_name
		,case 	when	l5.cur_area_ltst_clsd = 'Y' 	or 	l5.cur_area_team_ltst_nm	in	('ENGLISH/WELSH DUMMY DENTAL','UNIDENTIFIED DEPUTISING SERVICES','UNIDENTIFIED DOCTORS')	then	'-'
				else 	l5.cur_area_team_ltst_alt_cde	end		as	icb_code
		,case 	when	l5.cur_region_ltst_clsd = 'Y' 	or 	l5.cur_region_ltst_nm		in	('ENGLISH/WELSH DUMMY DENTAL','UNIDENTIFIED DEPUTISING SERVICES','UNIDENTIFIED DOCTORS')	then	'UNKNOWN REGION'
				else 	l5.cur_frmttd_region_ltst_nm	end		as	region_name
		,case 	when	l5.cur_region_ltst_clsd = 'Y' 	or 	l5.cur_region_ltst_nm		in	('ENGLISH/WELSH DUMMY DENTAL','UNIDENTIFIED DEPUTISING SERVICES','UNIDENTIFIED DOCTORS')	then	'-'
				else 	l5.cur_region_ltst_alt_cde		end		as	region_code
	from
		aml.px_form_item_elem_comb_fact_av  fact
	inner join
		tdim
		on	fact.year_month	=	tdim.year_month
	inner join
		drug
		on	fact.calc_prec_drug_record_id	=	drug.record_id
		and	fact.year_month					=	drug.year_month
    inner join
        dim.cur_ep_level_5_flat_dim l5
        on fact.presc_type_prnt = l5.lvl_5_oupdt
        and fact.presc_id_prnt = l5.lvl_5_ou
        and l5.cur_ctry_ou = 1
	where	1	=	1
		--	regular exlusions
		and	fact.PAY_DA_END			=	'N' -- excludes disallowed items
		and fact.PAY_ND_END			=	'N' -- excludes not dispensed items
		and fact.PAY_RB_END			=	'N' -- excludes referred back items
		and fact.CD_REQ				=	'N' -- excludes controlled drug requisitions
		and fact.OOHC_IND			=	0   -- excludes out of hours dispensing
		and fact.PRIVATE_IND		=	0   -- excludes private dispensers
		and fact.IGNORE_FLAG		=	'N' -- excludes LDP dummy forms	
		and	fact.PRESC_TYPE_PRNT	not in	(8,54)	-- excludes private and pharmacy prescribers
	group by
		tdim.financial_year
		,'England'							
		,drug.drug_type
		,fact.identified_patient_id
   		,fact.patient_identified
        ,case 	when	l5.cur_area_ltst_clsd = 'Y' 	or 	l5.cur_area_team_ltst_nm	in	('ENGLISH/WELSH DUMMY DENTAL','UNIDENTIFIED DEPUTISING SERVICES','UNIDENTIFIED DOCTORS')	then	'UNKNOWN ICB'
				else 	l5.cur_frmttd_area_team_ltst_nm	end
		,case 	when	l5.cur_area_ltst_clsd = 'Y' 	or 	l5.cur_area_team_ltst_nm	in	('ENGLISH/WELSH DUMMY DENTAL','UNIDENTIFIED DEPUTISING SERVICES','UNIDENTIFIED DOCTORS')	then	'-'
				else 	l5.cur_area_team_ltst_alt_cde	end	
		,case 	when	l5.cur_region_ltst_clsd = 'Y' 	or 	l5.cur_region_ltst_nm		in	('ENGLISH/WELSH DUMMY DENTAL','UNIDENTIFIED DEPUTISING SERVICES','UNIDENTIFIED DOCTORS')	then	'UNKNOWN REGION'
				else 	l5.cur_frmttd_region_ltst_nm	end	
		,case 	when	l5.cur_region_ltst_clsd = 'Y' 	or 	l5.cur_region_ltst_nm		in	('ENGLISH/WELSH DUMMY DENTAL','UNIDENTIFIED DEPUTISING SERVICES','UNIDENTIFIED DOCTORS')	then	'-'
				else 	l5.cur_region_ltst_alt_cde		end)

select
	financial_year
	,country
    ,icb_name
    ,icb_code
    ,region_name
    ,region_code
	,drug_type
	,patient_identified
	,sum(patient_count)	as	patients
	,sum(items)	as	items
	,sum(nic)	as	nic
from
	fact
where	1	=	1
group by
	financial_year
	,country
    ,icb_name
    ,icb_code
    ,region_name
    ,region_code
	,drug_type
	,patient_identified
order by
	financial_year
	,drug_type
	,patient_identified	desc